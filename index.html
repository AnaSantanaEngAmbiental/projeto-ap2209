<script>
/* ================================
   AP 2209 – SINCRONISMO MASTER V32
   Compatível iOS / Android
================================ */

const APP_VERSION = "32.0";

/* ---------- UTIL ---------- */
function simpleHash(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        hash = ((hash << 5) - hash) + str.charCodeAt(i);
        hash |= 0;
    }
    return hash;
}

function encodeData(data) {
    const json = JSON.stringify(data);
    return btoa(unescape(encodeURIComponent(json)));
}

function decodeData(data) {
    const json = decodeURIComponent(escape(atob(data)));
    return JSON.parse(json);
}

/* ---------- QR CODE ---------- */
function updateQRCode() {
    const payload = {
        v: APP_VERSION,
        t: Date.now(),
        d: inventory
    };

    const encoded = encodeData(payload);
    const hash = simpleHash(encoded);

    const syncUrl =
        location.origin +
        location.pathname +
        "?sync=" +
        encoded +
        "&h=" +
        hash;

    const qr = document.getElementById("qrcode");
    qr.innerHTML = "";

    new QRCode(qr, {
        text: syncUrl,
        width: 220,
        height: 220,
        colorDark: "#0f172a",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H // ⭐ ESSENCIAL PARA iOS
    });
}

/* ---------- SYNC ---------- */
function checkUrlUpdates() {
    const params = new URLSearchParams(window.location.search);
    const sync = params.get("sync");
    const hash = params.get("h");

    if (!sync || !hash) return;

    if (simpleHash(sync).toString() !== hash) {
        alert("❌ QR Code inválido ou corrompido.");
        return;
    }

    try {
        const payload = decodeData(sync);

        if (!payload.v || !payload.d) {
            alert("❌ Dados incompatíveis.");
            return;
        }

        if (confirm(`Sincronizar dados da versão ${payload.v}?`)) {
            inventory = payload.d;
            localStorage.setItem("ap2209_data", JSON.stringify(inventory));
            history.replaceState({}, document.title, location.pathname);
            render();
            alert("✅ Sincronização concluída com sucesso.");
        }

    } catch (e) {
        alert("❌ Falha ao importar dados.");
        console.error(e);
    }
}

/* ---------- LINK ---------- */
function syncData() {
    const payload = {
        v: APP_VERSION,
        t: Date.now(),
        d: inventory
    };

    const encoded = encodeData(payload);
    const hash = simpleHash(encoded);

    const syncUrl =
        location.origin +
        location.pathname +
        "?sync=" +
        encoded +
        "&h=" +
        hash;

    navigator.clipboard.writeText(syncUrl)
        .then(() => alert("✅ Link copiado com segurança."));
}

/* ---------- INIT ---------- */
window.addEventListener("load", () => {
    checkUrlUpdates();
    setTimeout(updateQRCode, 300);
});
</script>
